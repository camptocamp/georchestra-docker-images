#!/usr/bin/env bash
#
# git-sync-on-inotify-webhook
#
# Based on git-sync-on-inotify from simonthum/git-sync
# Enhanced with webhook notification support for monitoring
#
# This script watches a git repository for changes and automatically syncs them.
# It also sends webhook notifications after each sync to enable external monitoring.

GIT_SYNC_DIRECTORY="/mnt/geoserver_datadir"
GIT_SYNC_COMMAND="${GIT_SYNC_COMMAND:-git-sync}"
GIT_SYNC_INTERVAL="${GIT_SYNC_INTERVAL:-500}"
WEBHOOK_URL="${WEBHOOK_URL:-}"
WEBHOOK_METHOD="${WEBHOOK_METHOD:-GET}"

# Function to send webhook notification
send_webhook() {
    local status="$1"
    local message="$2"
    
    if [ -z "$WEBHOOK_URL" ]; then
        return 0
    fi
    
    local timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
    local hostname=$(hostname)
    
    if [ "$WEBHOOK_METHOD" = "POST" ]; then
        # Send JSON payload for POST requests
        curl -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{\"status\":\"$status\",\"message\":\"$message\",\"timestamp\":\"$timestamp\",\"hostname\":\"$hostname\"}" \
            --max-time 10 \
            --silent \
            --show-error \
            --fail \
            2>&1 | sed 's/^/webhook: /' || echo "webhook: Failed to send notification"
    else
        # Simple GET request (e.g., for UptimeRobot)
        curl -X GET "$WEBHOOK_URL" \
            --max-time 10 \
            --silent \
            --show-error \
            --fail \
            2>&1 | sed 's/^/webhook: /' || echo "webhook: Failed to send notification"
    fi
}

# Function to perform sync
do_sync() {
    local reason="$1"
    echo "Syncing: $reason"
    
    if $GIT_SYNC_COMMAND -n -s; then
        echo "Sync successful"
        send_webhook "success" "Sync completed: $reason"
        return 0
    else
        local exit_code=$?
        echo "Sync failed with exit code: $exit_code"
        send_webhook "error" "Sync failed (exit $exit_code): $reason"
        
        # Exit code 3 is typically network issues, don't stop the container
        if [ $exit_code -eq 3 ]; then
            echo "Network error detected, will retry on next sync"
            return 0
        fi
        
        # Exit code 1 typically means conflicts or manual intervention needed
        if [ $exit_code -eq 1 ]; then
            echo "ERROR: Manual intervention required!"
            echo "Stopping sync to prevent data loss."
            echo "Please check the repository state and resolve any conflicts."
            return 1
        fi
        
        return 0
    fi
}

# Ensure we're in the sync directory
if [ ! -d "$GIT_SYNC_DIRECTORY" ]; then
    echo "ERROR: Sync directory $GIT_SYNC_DIRECTORY does not exist"
    send_webhook "error" "Sync directory does not exist"
    exit 1
fi

cd "$GIT_SYNC_DIRECTORY"

# Get remote information for logging
remote_name=$(git config --get branch.$(basename $(git symbolic-ref -q HEAD)).pushRemote)
if [ -z "$remote_name" ]; then
    remote_name=$(git config --get branch.$(basename $(git symbolic-ref -q HEAD)).remote)
fi

if [ -n "$remote_name" ]; then
    remote_url=$(git remote get-url "$remote_name" 2>/dev/null || echo "unknown")
    echo "Syncing $remote_url at $(pwd)"
    echo "Default sync interval: ${GIT_SYNC_INTERVAL}ms"
else
    echo "Syncing local repository at $(pwd)"
    echo "Default sync interval: ${GIT_SYNC_INTERVAL}ms"
fi

if [ -n "$WEBHOOK_URL" ]; then
    echo "Webhook notifications enabled: $WEBHOOK_URL"
fi

# Perform initial sync
echo "======================================="
echo "Performing initial sync"
do_sync "initial sync" || exit 1
echo "======================================="

# Main watch loop
echo "Starting file watch loop"
while true; do
    changedFile=$(
        inotifywait "$GIT_SYNC_DIRECTORY" -r -e modify,move,create,delete \
            --format "%w%f" --exclude '\.git' -t "$GIT_SYNC_INTERVAL" 2>/dev/null
    )
    
    if [ -z "$changedFile" ]; then
        # Timeout occurred, do periodic sync
        do_sync "periodic sync (timeout)" || exit 1
    else
        # File change detected
        # Check if file is git-ignored before syncing
        if git check-ignore "$changedFile" > /dev/null 2>&1; then
            echo "Ignoring change to git-ignored file: $changedFile"
        else
            do_sync "file change: $changedFile" || exit 1
        fi
    fi
done
